<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Genexis Cloud – Bioinformatics Solutions</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Auth0 SPA JS -->
<script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>

<style>
/* -------------------------------------------------
   GLOBAL RESET & TYPOGRAPHY
------------------------------------------------- */
*{margin:0;padding:0;box-sizing:border-box}
html{font-size:16px}
body{
    min-height:100vh;
    font-family:'Segoe UI',Arial,sans-serif;
    background:#f4f7fb;
    color:#333;
    line-height:1.5;
}

/* -------------------------------------------------
   LAYOUT CONTAINER
------------------------------------------------- */
.container{
    max-width:1400px;
    margin:0 auto;
    padding:0 1rem;
}

/* -------------------------------------------------
   HEADER (logo + nav + CTA)
------------------------------------------------- */
header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:1.5rem 0;
}
.logo img{height:48px}
nav ul{
    display:flex;
    gap:2rem;
    list-style:none;
}
nav a{
    color:#2c3e50;
    font-weight:600;
    text-decoration:none;
    transition:color .2s;
}
nav a:hover{color:#0066ff}
.cta-btn{
    background:#0066ff;
    color:#fff;
    padding:.6rem 1.4rem;
    border-radius:8px;
    font-weight:600;
    text-decoration:none;
    transition:background .2s;
}
.cta-btn:hover{background:#0052cc}

/* -------------------------------------------------
   HERO SECTION
------------------------------------------------- */
.hero{
    text-align:center;
    padding:4rem 0 3rem;
}
.hero h1{
    font-size:2.8rem;
    margin-bottom:.8rem;
    color:#2c3e50;
}
.hero p{
    font-size:1.2rem;
    max-width:720px;
    margin:0 auto 2rem;
    color:#555;
}
.search-bar{
    max-width:560px;
    margin:0 auto;
    display:flex;
    background:#fff;
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,.08);
}
.search-bar input{
    flex:1;
    padding:1rem 1.2rem;
    border:none;
    font-size:1rem;
}
.search-bar button{
    background:#0066ff;
    color:#fff;
    border:none;
    padding:0 1.8rem;
    font-weight:600;
    cursor:pointer;
}

/* -------------------------------------------------
   SOLUTIONS GRID
------------------------------------------------- */
.solutions{
    padding:4rem 0;
}
.solutions h2{
    text-align:center;
    font-size:2.2rem;
    margin-bottom:2.5rem;
    color:#2c3e50;
}
.grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
    gap:1.8rem;
}
.card{
    background:#fff;
    border-radius:12px;
    overflow:hidden;
    box-shadow:0 4px 16px rgba(0,0,0,.07);
    transition:transform .25s,box-shadow .25s;
}
.card:hover{
    transform:translateY(-6px);
    box-shadow:0 12px 28px rgba(0,0,0,.12);
}
.card img{
    width:100%;
    height:180px;
    object-fit:cover;
}
.card-body{
    padding:1.4rem;
}
.card h3{
    font-size:1.25rem;
    margin-bottom:.5rem;
    color:#2c3e50;
}
.card p{
    font-size:.92rem;
    color:#666;
    margin-bottom:1rem;
}
.card .badge{
    display:inline-block;
    background:#e0f2ff;
    color:#0066ff;
    font-size:.78rem;
    font-weight:600;
    padding:.25rem .65rem;
    border-radius:20px;
}

/* -------------------------------------------------
   API SECTION
------------------------------------------------- */
.api-section{
    background:#fff;
    padding:4rem 0;
    text-align:center;
}
.api-section h2{
    font-size:2rem;
    margin-bottom:1.5rem;
    color:#2c3e50;
}
.code-block{
    max-width:720px;
    margin:2rem auto;
    background:#1e1e1e;
    color:#dcdcdc;
    padding:1.5rem;
    border-radius:8px;
    font-family:'Courier New',monospace;
    text-align:left;
    overflow-x:auto;
}

/* -------------------------------------------------
   FOOTER
------------------------------------------------- */
footer{
    background:#2c3e50;
    color:#ddd;
    text-align:center;
    padding:2rem 0;
    font-size:.9rem;
}

/* -------------------------------------------------
   DASHBOARD BUTTON
------------------------------------------------- */
.dashboard-btn{
    position:fixed;
    top:1.2rem;
    right:1.2rem;
    background:#28a745;
    color:#fff;
    padding:.6rem 1.2rem;
    border-radius:8px;
    font-weight:600;
    text-decoration:none;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
    z-index:999;
}
.dashboard-btn:hover{background:#218838}

/* -------------------------------------------------
   DEBUG CONSOLE
------------------------------------------------- */
.debug-console{
    position:fixed;bottom:20px;right:20px;width:400px;max-height:400px;
    background:rgba(0,0,0,.95);border:2px solid #00ff00;border-radius:8px;
    padding:15px;font-family:'Courier New',monospace;font-size:12px;
    overflow-y:auto;z-index:10000;box-shadow:0 4px 20px rgba(0,0,0,.5);
    display:none;
}
.debug-console h4{color:#00ff00;margin-bottom:10px;border-bottom:1px solid #00ff00;padding-bottom:5px}
.debug-line{margin:5px 0;padding:3px 5px;border-radius:3px}
.debug-line.info{color:#00bfff}
.debug-line.success{color:#00ff00;background:rgba(0,255,0,.1)}
.debug-line.error{color:#ff4444;background:rgba(255,0,0,.1)}
.debug-line.warning{color:#ffaa00;background:rgba(255,170,0,.1)}
.debug-toggle{
    position:fixed;bottom:20px;right:20px;
    padding:10px 15px;background:rgba(0,255,0,.2);
    border:2px solid #00ff00;border-radius:5px;color:#00ff00;
    font-weight:bold;z-index:9999;
}

/* -------------------------------------------------
   ORIGINAL DASHBOARD (kept hidden)
------------------------------------------------- */
#originalDashboard{display:none}

/* -------------------------------------------------
   ORIGINAL DASHBOARD STYLES (unchanged)
------------------------------------------------- */
.header { text-align:center; margin-bottom:30px; }
.header h1 { font-size:2.5rem; margin-bottom:0.3rem; }
.header p { font-size:1rem; opacity:0.85; }
.auth-status { margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 14px; }
.auth-controls { margin-top:10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap; align-items:center; }
.auth-controls button { padding:8px 16px; border:none; border-radius:8px; font-weight:600; backdrop-filter:blur(5px); background:rgba(255,255,255,0.2); color:#fff; }
.auth-controls button:hover { background:rgba(255,255,255,0.35); }
.auth-controls button:disabled { opacity:0.5; cursor:not-allowed; }

.controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; flex-wrap:wrap; gap:10px; }
.filter-btn { padding:8px 16px; font-size:13px; border:none; border-radius:8px; background:rgba(255,255,255,0.2); color:#fff; }
.filter-btn.active { background:rgba(255,255,255,0.4); font-weight:bold; }
.filter-btn:hover { background:rgba(255,255,255,0.35); }

.quick-links { backdrop-filter:blur(10px); background:rgba(255,255,255,0.15); padding:20px; border-radius:12px; margin-bottom:30px; }
.quick-links h3 { margin-bottom:15px; font-size:1.1rem; }
.links-list { display:flex; flex-wrap:wrap; gap:10px; }
.quick-link-item { display:flex; align-items:center; gap:8px; padding:8px 15px; border-radius:20px; background:rgba(255,255,255,0.2); font-size:13px; }
.quick-link-item button { background:rgba(255,255,255,0.3); border:none; border-radius:10px; padding:2px 8px; font-size:11px; color:#fff; }
.add-link-form { display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; display:none; }
.add-link-form.active { display:flex; }
.add-link-form input { flex:1; padding:8px 12px; border-radius:6px; border:none; font-size:13px; }

.tools-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:25px; margin-bottom:40px; }
.tool-card { background:#fff; color:#333; border-radius:12px; padding:25px; box-shadow:0 8px 25px rgba(0,0,0,0.2); transition:0.3s; position:relative; cursor:pointer; }
.tool-card:hover { transform:translateY(-5px); box-shadow:0 12px 35px rgba(0,0,0,0.3); }
.tool-card h3 { margin-bottom:8px; font-size:1.2rem; }
.tool-card p { font-size:0.85rem; color:#666; line-height:1.4; }
.tool-card .status { margin-top:12px; display:inline-block; padding:5px 12px; border-radius:20px; font-size:12px; font-weight:bold; color:#fff; background:#4CAF50; }
.status.coming-soon { background:#FF9800; }
.tool-actions { position:absolute; top:10px; right:10px; display:flex; gap:5px; }
.tool-action-btn { width:32px; height:32px; border-radius:50%; border:none; display:flex; justify-content:center; align-items:center; font-size:16px; background:rgba(0,0,0,0.1); }
.tool-action-btn:hover { background:rgba(0,0,0,0.2); }
.tool-action-btn.star.active { background:#FFD700; }
.tool-card.hidden { display:none; }

#favoritesSection { margin-bottom:30px; }
#favoritesSection h3 { margin-bottom:15px; font-size:1.2rem; }

.footer { text-align:center; margin-top:40px; font-size:14px; opacity:0.75; }

.modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:1000; }
.modal.active { display:flex; }
.modal-content { background:#fff; color:#333; padding:30px; border-radius:15px; max-width:500px; width:90%; text-align:center; position:relative; }
.modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
.modal-header h2 { font-size:1.5rem; }
.close-btn { background:none; border:none; font-size:28px; cursor:pointer; color:#999; }
.settings-section { margin-bottom: 20px; }
.settings-section button { width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px; background:#fff; transition:0.2s; }
.settings-section button:hover { background:#f5f5f5; border-color:#4CAF50; }

.hidden-tools-list { max-height:200px; overflow-y:auto; border:1px solid #ddd; border-radius:8px; padding:10px; }
.hidden-tool-item { display:flex; justify-content:space-between; align-items:center; padding:8px; margin-bottom:5px; background:#f9f9f9; border-radius:5px; }
.hidden-tool-item button { padding:4px 12px; background:#4CAF50; color:white; border:none; border-radius:5px; font-size:12px; }
</style>
</head>

<body>

<!-- DEBUG TOGGLE -->
<button class="debug-toggle" onclick="toggleDebug()">Toggle Debug</button>

<!-- DEBUG CONSOLE -->
<div class="debug-console" id="debugConsole">
    <h4>Debug Console</h4>
    <div id="debugLog"></div>
</div>

<!-- DASHBOARD QUICK-LINK -->
<a href="#" class="dashboard-btn" id="openDashboard">Dashboard</a>

<!-- ====================== NEW LANDING PAGE ====================== -->
<div class="container">

    <header>
        <div class="logo">
            <img src="https://via.placeholder.com/180x48/0066ff/ffffff?text=GENEXIS+CLOUD" alt="Genexis Cloud Logo">
        </div>
        <nav>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#">Solutions</a></li>
                <li><a href="#">Documentation</a></li>
                <li><a href="#">API</a></li>
                <li><a href="#">Pricing</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
        </nav>
        <a href="#" class="cta-btn">Get Started</a>
    </header>

    <section class="hero">
        <h1>Bioinformatics Solutions</h1>
        <p>Harnessing Data for Discovery</p>
        <div class="search-bar">
            <input type="text" placeholder="Search Documentation">
            <button>Submit</button>
        </div>
    </section>

    <section class="solutions">
        <h2>Our Solutions</h2>
        <div class="grid">
            <div class="card">
                <img src="https://via.placeholder.com/400x180/4a90e2/ffffff?text=Genomic+Data+Analysis" alt="">
                <div class="card-body">
                    <h3>Genomic Data Analysis</h3>
                    <p>Process, analyze, and visualize large-scale genomic datasets with ease.</p>
                    <span class="badge">Active</span>
                </div>
            </div>
            <div class="card">
                <img src="https://via.placeholder.com/400x180/50c8ff/ffffff?text=RNA+Sequencing" alt="">
                <div class="card-body">
                    <h3>RNA Sequencing</h3>
                    <p>From raw reads to differential expression – all in one platform.</p>
                    <span class="badge">Active</span>
                </div>
            </div>
            <div class="card">
                <img src="https://via.placeholder.com/400x180/7ed321/ffffff?text=Unassembling" alt="">
                <div class="card-body">
                    <h3>Unassembling</h3>
                    <p>De-novo assembly of complex genomes with unmatched speed.</p>
                    <span class="badge">Coming Soon</span>
                </div>
            </div>
            <div class="card">
                <img src="https://via.placeholder.com/400x180/ff6b6b/ffffff?text=Protein+Cryo-EM" alt="">
                <div class="card-body">
                    <h3>Protein Cryo-EM</h3>
                    <p>High-resolution structure determination from cryo-EM data.</p>
                    <span class="badge">Active</span>
                </div>
            </div>
            <div class="card">
                <img src="https://via.placeholder.com/400x180/ffb800/ffffff?text=High+Scale" alt="">
                <div class="card-body">
                    <h3>High Scale</h3>
                    <p>Process terabyte-scale datasets on cloud-native infrastructure.</p>
                    <span class="badge">Active</span>
                </div>
            </div>
            <div class="card">
                <img src="https://via.placeholder.com/400x180/9b59b6/ffffff?text=Costly+Sets" alt="">
                <div class="card-body">
                    <h3>Costly Sets</h3>
                    <p>Advanced statistical modeling for expensive experimental designs.</p>
                    <span class="badge">Coming Soon</span>
                </div>
            </div>
        </div>
    </section>

    <section class="api-section">
        <h2>API Documentation</h2>
        <p>Integrate with Ease</p>
        <div class="code-block">
            <pre>
curl -X POST https://api.genexis.cloud/v1/predict \
  -H "Authorization: Bearer &lt;YOUR_TOKEN&gt;" \
  -H "Content-Type: application/json" \
  -d '{
        "sequence": "ATCG...",
        "model": "protein_structure"
      }'</pre>
        </div>
    </section>

</div>

<footer>
    © 2025 Genexis Cloud. All rights reserved.
</footer>

<!-- ====================== ORIGINAL DASHBOARD (hidden) ====================== -->
<div id="originalDashboard">

<div class="header">
    <h1>Plant Breeding Tools Dashboard</h1>
    <p>Manage your tools, favorites, hidden items, and quick links easily.</p>
    <div class="auth-status" id="authStatus">
        <div>Status: <span id="authStatusText">Initializing...</span></div>
        <div id="authError" style="color: #ff6b6b; margin-top: 5px;"></div>
    </div>
    <div class="auth-controls">
        <span id="userProfile"></span>
        <button id="loginBtn" onclick="login()" disabled>Loading Auth0...</button>
        <button id="logoutBtn" onclick="logout()" style="display:none;">Logout</button>
    </div>
</div>

<div class="container">
    <!-- FILTER CONTROLS -->
    <div class="controls">
        <div>
            <button class="filter-btn active" onclick="filterTools('all', event)">All Tools</button>
            <button class="filter-btn" onclick="filterTools('favorites', event)">Favorites</button>
            <button class="filter-btn" onclick="filterTools('active', event)">Active Only</button>
        </div>
        <div>
            <button class="filter-btn" onclick="openSettings()">Settings</button>
        </div>
    </div>

    <!-- QUICK LINKS -->
    <div class="quick-links">
        <h3>Quick Links</h3>
        <div class="links-list" id="linksList"></div>
        <div id="addLinkForm" class="add-link-form">
            <input type="text" id="linkName" placeholder="Link Name">
            <input type="url" id="linkUrl" placeholder="Link URL">
            <button onclick="addQuickLink()">Add</button>
        </div>
        <button onclick="toggleAddLinkForm()" class="filter-btn">+ Add Quick Link</button>
    </div>

    <!-- FAVORITES -->
    <div id="favoritesSection" style="display:none;">
        <h3>Favorites</h3>
        <div class="tools-grid" id="favoritesGrid"></div>
    </div>

    <!-- ALL TOOLS -->
    <div>
        <h3 style="margin-bottom: 15px;">All Tools</h3>
        <div class="tools-grid" id="toolsGrid">
            <div class="tool-card" data-id="tool1" data-status="active">
                <div class="tool-actions">
                    <button class="tool-action-btn star" onclick="toggleFavorite(event,'tool1')">Star</button>
                    <button class="tool-action-btn hide" onclick="hideTool(event,'tool1')">X</button>
                </div>
                <h3>Breeding Calculator</h3>
                <p>Calculate cross predictions and genetic ratios for your breeding programs.</p>
                <span class="status">Active</span>
            </div>
            <div class="tool-card" data-id="tool2" data-status="coming-soon">
                <div class="tool-actions">
                    <button class="tool-action-btn star" onclick="toggleFavorite(event,'tool2')">Star</button>
                    <button class="tool-action-btn hide" onclick="hideTool(event,'tool2')">X</button>
                </div>
                <h3>Field Trial Manager</h3>
                <p>Manage and analyze your field trial data with statistical tools.</p>
                <span class="status coming-soon">Coming Soon</span>
            </div>
            <div class="tool-card" data-id="tool3" data-status="active">
                <div class="tool-actions">
                    <button class="tool-action-btn star" onclick="toggleFavorite(event,'tool3')">Star</button>
                    <button class="tool-action-btn hide" onclick="hideTool(event,'tool3')">X</button>
                </div>
                <h3>Germplasm Database</h3>
                <p>Search and manage your germplasm collection with detailed records.</p>
                <span class="status">Active</span>
            </div>
            <div class="tool-card" data-id="tool4" data-status="active">
                <div class="tool-actions">
                    <button class="tool-action-btn star" onclick="toggleFavorite(event,'tool4')">Star</button>
                    <button class="tool-action-btn hide" onclick="hideTool(event,'tool4')">X</button>
                </div>
                <h3>Pedigree Visualizer</h3>
                <p>Visualize breeding pedigrees and track lineage relationships.</p>
                <span class="status">Active</span>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    &copy; 2025 Plant Breeding Dashboard. All rights reserved.
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Settings</h2>
            <button class="close-btn" onclick="closeSettings()">X</button>
        </div>
        <div class="settings-section">
            <h3 style="margin-bottom: 10px; text-align: left;">Data Management</h3>
            <button onclick="resetFavorites()">Reset Favorites</button>
            <button onclick="resetHidden()">Show All Hidden Tools</button>
            <button onclick="resetAll()">Reset Everything</button>
        </div>
        <div class="settings-section">
            <h3 style="margin-bottom: 10px; text-align: left;">Import/Export</h3>
            <button onclick="exportSettings()">Export Settings</button>
            <button onclick="document.getElementById('importFile').click()">Import Settings</button>
            <input type="file" id="importFile" style="display:none;" accept=".json" onchange="importSettings(event)">
        </div>
        <div class="settings-section">
            <h3 style="margin-bottom: 10px; text-align: left;">Hidden Tools</h3>
            <div class="hidden-tools-list" id="hiddenToolsList"></div>
        </div>
    </div>
</div>

</div> <!-- end #originalDashboard -->

<script>
/* ------------------ DEBUG LOGGING ------------------ */
let debugMessages = [];
let debugConsoleVisible = false;

function debugLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = { timestamp, message, type };
    debugMessages.push(logEntry);
    
    console.log(`[${type.toUpperCase()}] ${timestamp}: ${message}`);
    
    updateDebugConsole();
}

function updateDebugConsole() {
    const debugLog = document.getElementById('debugLog');
    if (!debugLog) return;
    
    debugLog.innerHTML = debugMessages.slice(-50).reverse().map(entry => 
        `<div class="debug-line ${entry.type}">[${entry.timestamp}] ${entry.message}</div>`
    ).join('');
}

function toggleDebug() {
    debugConsoleVisible = !debugConsoleVisible;
    document.getElementById('debugConsole').style.display = debugConsoleVisible ? 'block' : 'none';
}

/* ------------------ GLOBAL STATE ------------------ */
let auth0Client = null;
let currentUser = null;
let favorites = [];
let hiddenTools = [];
let quickLinks = [];
let currentFilter = 'all';

/* ------------------ AUTH0 INITIALIZATION ------------------ */
async function initAuth0() {
    debugLog('Starting Auth0 initialization...', 'info');
    
    const loginBtn = document.getElementById('loginBtn');
    const authStatusText = document.getElementById('authStatusText');
    const authError = document.getElementById('authError');
    
    try {
        debugLog('Checking for window.auth0...', 'info');
        if (typeof window.auth0 === 'undefined') {
            throw new Error('window.auth0 is undefined - CDN script may not have loaded');
        }
        debugLog('window.auth0 exists', 'success');
        
        debugLog('Checking for createAuth0Client...', 'info');
        if (typeof window.auth0.createAuth0Client !== 'function') {
            throw new Error('window.auth0.createAuth0Client is not a function');
        }
        debugLog('createAuth0Client is a function', 'success');
        
        debugLog('Creating Auth0 client...', 'info');
        
        let redirectUri = window.location.origin + window.location.pathname;
        if (!redirectUri.endsWith('/')) {
            redirectUri += '/';
        }
        
        debugLog('Redirect URI: ' + redirectUri, 'info');
        
        const config = {
            domain: 'dev-hctfmbntodg4ekwd.us.auth0.com',
            clientId: 'v6yhw1p536sLDxH95gaT8DWd9KJ4nj6k',
            authorizationParams: {
                redirect_uri: redirectUri
            },
            cacheLocation: 'localstorage',
            useRefreshTokens: true
        };
        debugLog('Config: ' + JSON.stringify(config, null, 2), 'info');
        
        auth0Client = await window.auth0.createAuth0Client(config);
        debugLog('Auth0 client created successfully', 'success');
        
        loginBtn.disabled = false;
        loginBtn.textContent = 'Login';
        authStatusText.textContent = 'Ready';
        authStatusText.style.color = '#00ff00';
        debugLog('Login button enabled', 'success');
        
        debugLog('Checking for authentication callback...', 'info');
        await handleAuth();
        
    } catch(err) {
        debugLog('Auth0 initialization FAILED: ' + err.message, 'error');
        debugLog('Error stack: ' + err.stack, 'error');
        
        authError.textContent = '' + err.message;
        authStatusText.textContent = 'Failed';
        authStatusText.style.color = '#ff6b6b';
        loginBtn.disabled = true;
        loginBtn.textContent = 'Login Unavailable';
        
        debugLog('Window object keys containing "auth": ' + 
            Object.keys(window).filter(k => k.toLowerCase().includes('auth')).join(', '), 'info');
        debugLog('Document scripts: ' + 
            Array.from(document.scripts).map(s => s.src).join(', '), 'info');
    }
}

async function handleAuth() {
    try {
        const urlParams = new URLSearchParams(window.location.search);
        debugLog('URL params: ' + window.location.search, 'info');
        
        if (urlParams.has('code') && urlParams.has('state')) {
            debugLog('Detected OAuth callback, handling redirect...', 'info');
            
            const result = await auth0Client.handleRedirectCallback();
            debugLog('Redirect callback handled successfully', 'success');
            debugLog('Result: ' + JSON.stringify(result), 'info');
            
            window.history.replaceState({}, document.title, window.location.pathname);
            debugLog('URL cleaned', 'info');
        }
        
        debugLog('Checking if user is authenticated...', 'info');
        const isAuthenticated = await auth0Client.isAuthenticated();
        debugLog('Is authenticated: ' + isAuthenticated, isAuthenticated ? 'success' : 'info');
        
        await updateAuthUI(isAuthenticated);
        
    } catch(err) {
        debugLog('Error handling auth: ' + err.message, 'error');
        debugLog('Error stack: ' + err.stack, 'error');
        document.getElementById('authError').textContent = '' + err.message;
    }
}

async function updateAuthUI(isAuthenticated = false) {
    debugLog('Updating auth UI, authenticated: ' + isAuthenticated, 'info');
    
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userProfile = document.getElementById('userProfile');
    const authStatusText = document.getElementById('authStatusText');

    loginBtn.style.display = isAuthenticated ? 'none' : 'inline-block';
    logoutBtn.style.display = isAuthenticated ? 'inline-block' : 'none';

    if (isAuthenticated) {
        currentUser = await auth0Client.getUser();
        debugLog('Current user: ' + JSON.stringify(currentUser), 'success');
        
        userProfile.textContent = `${currentUser.name || currentUser.email}`;
        authStatusText.textContent = 'Authenticated';
        authStatusText.style.color = '#00ff00';
        
        loadUserSettings();
    } else {
        currentUser = null;
        userProfile.textContent = '';
        authStatusText.textContent = 'Not logged in';
        authStatusText.style.color = '#ffaa00';
        
        loadLocalSettings();
    }
}

async function login() {
    debugLog('Login button clicked', 'info');
    
    if (!auth0Client) {
        debugLog('Cannot login: auth0Client is null', 'error');
        alert('Auth0 is not initialized yet. Please check the debug console.');
        return;
    }
    
    try {
        debugLog('Starting login redirect...', 'info');
        
        let redirectUri = window.location.origin + window.location.pathname;
        if (!redirectUri.endsWith('/')) {
            redirectUri += '/';
        }
        
        debugLog('Login redirect URI: ' + redirectUri, 'info');
        
        await auth0Client.loginWithRedirect({
            authorizationParams: {
                redirect_uri: redirectUri
            }
        });
        
        debugLog('Login redirect initiated (you should be redirected now)', 'success');
    } catch(err) {
        debugLog('Login failed: ' + err.message, 'error');
        debugLog('Error stack: ' + err.stack, 'error');
        alert('Login failed: ' + err.message);
    }
}

async function logout() {
    debugLog('Logout initiated', 'info');
    
    if (!auth0Client) {
        debugLog('Cannot logout: auth0Client is null', 'error');
        return;
    }
    
    try {
        currentUser = null;
        document.getElementById('userProfile').textContent = '';
        document.getElementById('authStatusText').textContent = 'Logging out...';
        
        favorites = [];
        hiddenTools = [];
        quickLinks = [];
        
        localStorage.clear();
        debugLog('Local storage cleared', 'info');
        
        let returnTo = window.location.origin + window.location.pathname;
        if (!returnTo.endsWith('/')) {
            returnTo += '/';
        }
        
        debugLog('Logout return URI: ' + returnTo, 'info');
        
        await auth0Client.logout({
            logoutParams: {
                returnTo: returnTo
            }
        });
        
        debugLog('Logout completed', 'success');
    } catch(err) {
        debugLog('Logout error: ' + err.message, 'error');
    }
}

/* ------------------ SETTINGS MANAGEMENT ------------------ */
function loadUserSettings() {
    debugLog('Loading user settings...', 'info');
    const key = currentUser ? `settings_${currentUser.sub}` : 'settings_guest';
    const saved = localStorage.getItem(key);
    
    if (saved) {
        try {
            const data = JSON.parse(saved);
            favorites = data.favorites || [];
            hiddenTools = data.hiddenTools || [];
            quickLinks = data.quickLinks || [];
            debugLog(`Loaded ${favorites.length} favorites, ${hiddenTools.length} hidden tools, ${quickLinks.length} quick links`, 'success');
        } catch(err) {
            debugLog('Error parsing saved settings: ' + err.message, 'error');
        }
    } else {
        debugLog('No saved settings found', 'info');
    }
    
    renderDashboard();
}

function loadLocalSettings() {
    debugLog('Loading local (guest) settings...', 'info');
    loadUserSettings();
}

function saveUserSettings() {
    const key = currentUser ? `settings_${currentUser.sub}` : 'settings_guest';
    const data = { favorites, hiddenTools, quickLinks };
    localStorage.setItem(key, JSON.stringify(data));
    debugLog('Settings saved to localStorage', 'info');
}

function renderDashboard() {
    debugLog('Rendering dashboard...', 'info');
    applyFilter();
    renderQuickLinks();
    updateHiddenToolsList();
}

/* ------------------ FAVORITES ------------------ */
function toggleFavorite(event, toolId) {
    event.stopPropagation();
    const idx = favorites.indexOf(toolId);
    
    if (idx > -1) {
        favorites.splice(idx, 1);
        debugLog(`Removed ${toolId} from favorites`, 'info');
    } else {
        favorites.push(toolId);
        debugLog(`Added ${toolId} to favorites`, 'info');
    }
    
    saveUserSettings();
    renderDashboard();
}

/* ------------------ HIDE/SHOW TOOLS ------------------ */
function hideTool(event, toolId) {
    event.stopPropagation();
    
    if (!hiddenTools.includes(toolId)) {
        hiddenTools.push(toolId);
        debugLog(`Hidden tool: ${toolId}`, 'info');
    }
    
    saveUserSettings();
    renderDashboard();
}

function showTool(toolId) {
    hiddenTools = hiddenTools.filter(id => id !== toolId);
    debugLog(`Unhidden tool: ${toolId}`, 'info');
    saveUserSettings();
    renderDashboard();
}

/* ------------------ FILTERING ------------------ */
function filterTools(filter, event) {
    currentFilter = filter;
    debugLog(`Filter changed to: ${filter}`, 'info');
    
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    if (event) event.target.classList.add('active');
    
    applyFilter();
}

function applyFilter() {
    const allCards = document.querySelectorAll('#toolsGrid .tool-card');
    const favSection = document.getElementById('favoritesSection');
    const favGrid = document.getElementById('favoritesGrid');
    
    favGrid.innerHTML = '';
    favSection.style.display = 'none';
    
    let visibleCount = 0;
    
    allCards.forEach(card => {
        const toolId = card.dataset.id;
        const status = card.dataset.status;
        const isFav = favorites.includes(toolId);
        const isHidden = hiddenTools.includes(toolId);
        
        const star = card.querySelector('.star');
        if (star) {
            star.classList.toggle('active', isFav);
        }
        
        if (isHidden) {
            card.classList.add('hidden');
            return;
        }
        
        card.classList.remove('hidden');
        
        if (currentFilter === 'favorites' && !isFav) {
            card.classList.add('hidden');
            return;
        }
        
        if (currentFilter === 'active' && status !== 'active') {
            card.classList.add('hidden');
            return;
        }
        
        visibleCount++;
        
        if (isFav && currentFilter === 'all') {
            const clone = card.cloneNode(true);
            favGrid.appendChild(clone);
            favSection.style.display = 'block';
        }
    });
    
    debugLog(`Visible tools: ${visibleCount}`, 'info');
}

/* ------------------ QUICK LINKS ------------------ */
function renderQuickLinks() {
    const list = document.getElementById('linksList');
    
    if (quickLinks.length === 0) {
        list.innerHTML = '<div style="color: rgba(255,255,255,0.6); font-size: 14px;">No quick links yet. Add one!</div>';
        return;
    }
    
    list.innerHTML = quickLinks.map((link, i) => `
        <div class="quick-link-item">
            <a href="${link.url}" target="_blank" rel="noopener">${link.name}</a>
            <button onclick="removeQuickLink(${i})">X</button>
        </div>
    `).join('');
}

function addQuickLink() {
    const name = document.getElementById('linkName').value.trim();
    const url = document.getElementById('linkUrl').value.trim();
    
    if (!name || !url) {
        alert('Please fill both fields');
        return;
    }
    
    quickLinks.push({ name, url });
    debugLog(`Added quick link: ${name} -> ${url}`, 'success');
    
    document.getElementById('linkName').value = '';
    document.getElementById('linkUrl').value = '';
    
    saveUserSettings();
    renderQuickLinks();
}

function removeQuickLink(index) {
    const removed = quickLinks[index];
    quickLinks.splice(index, 1);
    debugLog(`Removed quick link: ${removed.name}`, 'info');
    
    saveUserSettings();
    renderQuickLinks();
}

function toggleAddLinkForm() {
    const form = document.getElementById('addLinkForm');
    form.classList.toggle('active');
    debugLog('Toggled add link form', 'info');
}

/* ------------------ SETTINGS MODAL ------------------ */
function openSettings() {
    document.getElementById('settingsModal').classList.add('active');
    updateHiddenToolsList();
    debugLog('Settings modal opened', 'info');
}

function closeSettings() {
    document.getElementById('settingsModal').classList.remove('active');
    debugLog('Settings modal closed', 'info');
}

function updateHiddenToolsList() {
    const list = document.getElementById('hiddenToolsList');
    
    if (hiddenTools.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No hidden tools</p>';
        return;
    }
    
    list.innerHTML = hiddenTools.map(id => {
        const card = document.querySelector(`[data-id="${id}"]`);
        const name = card ? card.querySelector('h3').textContent : id;
        return `
            <div class="hidden-tool-item">
                <span>${name}</span>
                <button onclick="showTool('${id}')">Show</button>
            </div>
        `;
    }).join('');
}

function resetFavorites() {
    if (confirm('Reset all favorites? This cannot be undone.')) {
        favorites = [];
        debugLog('All favorites reset', 'warning');
        saveUserSettings();
        renderDashboard();
    }
}

function resetHidden() {
    if (confirm('Show all hidden tools?')) {
        const count = hiddenTools.length;
        hiddenTools = [];
        debugLog(`${count} hidden tools restored`, 'warning');
        saveUserSettings();
        renderDashboard();
        updateHiddenToolsList();
    }
}

function resetAll() {
    if (confirm('Reset everything? This will clear all your favorites, hidden tools, and quick links. This cannot be undone.')) {
        favorites = [];
        hiddenTools = [];
        quickLinks = [];
        debugLog('All settings reset', 'warning');
        saveUserSettings();
        renderDashboard();
        closeSettings();
    }
}

function exportSettings() {
    const data = {
        favorites,
        hiddenTools,
        quickLinks,
        exportDate: new Date().toISOString(),
        user: currentUser ? currentUser.email : 'guest'
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dashboard-settings-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    debugLog('Settings exported', 'success');
}

function importSettings(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    debugLog(`Importing settings from: ${file.name}`, 'info');
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const data = JSON.parse(e.target.result);
            
            favorites = data.favorites || [];
            hiddenTools = data.hiddenTools || [];
            quickLinks = data.quickLinks || [];
            
            debugLog(`Imported ${favorites.length} favorites, ${hiddenTools.length} hidden tools, ${quickLinks.length} quick links`, 'success');
            
            saveUserSettings();
            renderDashboard();
            
            alert('Settings imported successfully!');
        } catch (err) {
            debugLog('Failed to import settings: ' + err.message, 'error');
            alert('Failed to import settings: ' + err.message);
        }
    };
    reader.readAsText(file);
}

/* ------------------ DASHBOARD TOGGLE ------------------ */
document.getElementById('openDashboard').addEventListener('click', e=>{
    e.preventDefault();
    document.querySelector('.container').style.display='none';
    document.getElementById('originalDashboard').style.display='block';
    // re-init Auth0 if needed
    if (typeof initAuth0 === 'function') initAuth0();
});

/* ------------------ INITIALIZATION ------------------ */
window.addEventListener('DOMContentLoaded', async () => {
    debugLog('=== APPLICATION STARTING ===', 'info');
    debugLog('DOM Content Loaded', 'info');
    debugLog('Current URL: ' + window.location.href, 'info');
    debugLog('User Agent: ' + navigator.userAgent, 'info');
    
    const auth0Script = Array.from(document.scripts).find(s => s.src.includes('auth0'));
    if (auth0Script) {
        debugLog('Auth0 script tag found: ' + auth0Script.src, 'success');
    } else {
        debugLog('Auth0 script tag NOT found', 'error');
    }
    
    await new Promise(resolve => setTimeout(resolve, 500));
    await initAuth0();
    
    debugLog('=== INITIALIZATION COMPLETE ===', 'success');
});

window.addEventListener('error', (event) => {
    debugLog('Uncaught error: ' + event.message, 'error');
    debugLog('Error at: ' + event.filename + ':' + event.lineno + ':' + event.colno, 'error');
});

window.addEventListener('unhandledrejection', (event) => {
    debugLog('Unhandled promise rejection: ' + event.reason, 'error');
});

debugLog('Script loaded and event listeners registered', 'success');
</script>

</body>
</html>
